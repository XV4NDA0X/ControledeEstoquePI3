<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Controle de Estoque</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/Babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="root" class="container mx-auto p-4"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Componente principal
    function App() {
      const [products, setProducts] = useState([]);
      const [name, setName] = useState('');
      const [quantity, setQuantity] = useState('');
      const [expiry, setExpiry] = useState('');
      const [sales, setSales] = useState('');

      // Carrega produtos do localStorage ao iniciar
      useEffect(() => {
        const savedProducts = JSON.parse(localStorage.getItem('products')) || [];
        setProducts(savedProducts);
      }, []);

      // Salva produtos no localStorage sempre que a lista mudar
      useEffect(() => {
        localStorage.setItem('products', JSON.stringify(products));
      }, [products]);

      // Adiciona novo produto
      const addProduct = (e) => {
        e.preventDefault();
        if (!name || !quantity || !expiry || !sales) {
          alert('Preencha todos os campos!');
          return;
        }
        const newProduct = {
          id: Date.now(),
          name,
          quantity: parseInt(quantity),
          expiry,
          sales: parseInt(sales),
        };
        setProducts([...products, newProduct]);
        setName('');
        setQuantity('');
        setExpiry('');
        setSales('');
      };

      // Remove produto
      const removeProduct = (id) => {
        setProducts(products.filter((product) => product.id !== id));
      };

      return (
        <div className="space-y-6">
          <h1 className="text-3xl font-bold text-center text-gray-800">
            Controle de Estoque e Validade
          </h1>

          {/* Formulário para adicionar produtos */}
          <form onSubmit={addProduct} className="bg-white p-6 rounded-lg shadow-md">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input
                type="text"
                placeholder="Nome do Produto"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <input
                type="number"
                placeholder="Quantidade"
                value={quantity}
                onChange={(e) => setQuantity(e.target.value)}
                className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <input
                type="date"
                value={expiry}
                onChange={(e) => setExpiry(e.target.value)}
                className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <input
                type="number"
                placeholder="Vendas (unidades)"
                value={sales}
                onChange={(e) => setSales(e.target.value)}
                className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              type="submit"
              className="mt-4 w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600"
            >
              Adicionar Produto
            </button>
          </form>

          {/* Lista de produtos */}
          <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4">Produtos em Estoque</h2>
            {products.length === 0 ? (
              <p className="text-gray-500">Nenhum produto cadastrado.</p>
            ) : (
              <ul className="space-y-2">
                {products.map((product) => (
                  <li
                    key={product.id}
                    className="flex justify-between items-center p-2 border-b"
                  >
                    <div>
                      <p className="font-medium">{product.name}</p>
                      <p className="text-sm text-gray-600">
                        Quantidade: {product.quantity} | Validade: {product.expiry} | Vendas: {product.sales}
                      </p>
                    </div>
                    <button
                      onClick={() => removeProduct(product.id)}
                      className="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600"
                    >
                      Remover
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>

          {/* Gráfico de produtos mais vendidos */}
          <SalesChart products={products} />
        </div>
      );
    }

    // Componente para o gráfico
    function SalesChart({ products }) {
      const canvasRef = React.useRef(null);
      let chartInstance = null;

      useEffect(() => {
        if (canvasRef.current) {
          // Destruir gráfico existente, se houver
          if (chartInstance) {
            chartInstance.destroy();
          }

          // Preparar dados para o gráfico
          const sortedProducts = [...products].sort((a, b) => b.sales - a.sales).slice(0, 5);
          const labels = sortedProducts.map((p) => p.name);
          const data = sortedProducts.map((p) => p.sales);

          // Criar novo gráfico
          chartInstance = new Chart(canvasRef.current, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                {
                  label: 'Unidades Vendidas',
                  data,
                  backgroundColor: 'rgba(59, 130, 246, 0.5)',
                  borderColor: 'rgba(59, 130, 246, 1)',
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Unidades Vendidas',
                  },
                },
                x: {
                  title: {
                    display: true,
                    text: 'Produtos',
                  },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
                title: {
                  display: true,
                  text: 'Top 5 Produtos Mais Vendidos',
                  font: {
                    size: 18,
                  },
                },
              },
            },
          });
        }

        // Cleanup: destruir gráfico ao desmontar componente
        return () => {
          if (chartInstance) {
            chartInstance.destroy();
          }
        };
      }, [products]);

      return (
        <div className="bg-white p-6 rounded-lg shadow-md">
          <canvas ref={canvasRef}></canvas>
        </div>
      );
    }

    // Renderizar aplicação
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
